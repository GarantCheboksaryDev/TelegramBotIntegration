# TelegramBotIntegration
Репозиторий шаблона разработки «Чат-бот Telegram». Код сервиса для обработки сообщений в чате.

## Функционал, предоставляемый шаблоном решения:

![image](https://github.com/user-attachments/assets/63cb6ae1-6e29-42d9-9d80-8485d737bea3)  
*Главное меню чат-бота.*

### 1.	Регистрация в чат-боте.
Регистрация сотрудника в чат-боте может быть произведена:
1. Администратором. Администратор создает новую запись справочника "Пользователи чат-бота". Указывает в ней сотрудника и его логин в Telegram. 
2. Самим сотрудником в том случае, если в его записи справочника "Сотрудники" в Directum RX указан адрес электронной почты:
    - Чат-бот запрашивает у пользователя в чате адрес почты. Далее происходит проверка, есть ли в Directum RX действующая запись справочника "Сотрудники", в которой поле "Эл. почта" совпадает с электронной почтой, введенной пользователем.  
    - В случае, если сотрудник в Directum RX найден, на адрес почты, введенной пользователем, отправляется код подтверждения. Если сотрудник верно вводит код подтверждения в чате, то в Directum RX создается новая запись справочника "Пользователи чат-бота".  

### 2. Авторизация в чат-боте.
Авторизация сотрудника происходит при каждом открытии главного меню чат-бота и по прошествии 60 секунд с момента последней авторизации. Авторизация заключается в том, что происходит поиск записи справочника "Пользователи чат-бота", в которой поле "Имя пользователя" совпадает с логином текущего пользователя в Telegram.
1. В случае, если запись справочника "Пользователи чат-бота не найдена", чат-бот предлагает пользователю пройти процедуру регистрации.
2. В случае, если запись справочника "Пользователи чат-бота найдена" и находится в состоянии "Закрыта", пользователю выводится сообщение "Ваша учетная запись заблокирована".
3. В случае, если запись справочника "Пользователи чат-бота найдена" и находится в состоянии "Действующая", пользователь может выполнять действия в чат-боте.

### 3.	Получение информации о контрагентах.
1. Чат-бот запрашивает наименование контрагента.  
![image](https://github.com/user-attachments/assets/420bddee-4a67-4f77-8aca-f4998760b21e)
2. В чат выводится список контрагентов, наименования которых содержат введенную пользователем строку.  
![image](https://github.com/user-attachments/assets/2adcadb3-5e04-4b77-badf-8f7c16d64778)
3.  Если список найденных контрагентов занимает больше 5 строк, то в список кнопок добавляются «Далее» и «Назад» для перехода по списку записей. Список записей, получаемых из сервиса интеграции, ограничивается 200 записями, т.к. при большем количестве найденных записей перемещаться по ним будет неудобно.  
![image](https://github.com/user-attachments/assets/3d372346-6ce7-4cd6-a0a9-2f6ecb8a3e5b)
4. При нажатии на кнопку с наименованием нужного пользователю контрагента, выводится информация о нем в текстовом виде.  
![image](https://github.com/user-attachments/assets/cdc617e8-427d-4992-b9c2-4fe2fbc06b86)

### 4.	Поиск документов.
1. Чат-бот предлагает выбрать тип документа, по которому пользователь хочет осуществить поиск. Для этого чат-бот получает список типов документов из справочника "Типы документов" в Directum RX и выводит их наименования в виде кнопок клавиатуры в чат с пользователем.  
![image](https://github.com/user-attachments/assets/bc060b10-9913-4ab7-9836-4c83ffa36ddf)
2. После выбора типа документа чат-бот предлагает ввести наименование документа.  
![image](https://github.com/user-attachments/assets/1408f09a-9074-4190-9c2b-fee10439e5b5)
3. После ввода наименования документа чат-бот отправляет запрос в сервис интеграции Directum RX для получения списка документов с фильтром по типу документа и наименованию. Список ограничивается 200 документами, т.к. при большем количестве найденных записей перемещаться по ним будет неудобно. Если найдено более 5 документов, то в список кнопок добавляются «Далее» и «Назад» для перехода по списку записей. В список попадают только те документы, на которые у текущего сотрудника есть права на просмотр.  
![image](https://github.com/user-attachments/assets/49959821-2760-40b8-ae16-dd0b92198522)
4. После того, как пользователь выберет нужный документ, чат-бот отправляет последнюю версию данного документа в чат.  
![image](https://github.com/user-attachments/assets/d896ddaa-dbf5-4016-997a-5649f94d2598)

### 5.	Отправка задач на исполнение заявок в Directum RX.
1. Чат-бот запрашивает у пользователя описание заявки в свободной форме. При необходимости, можно прикрепить к сообщению вложение (например, фото или видео).
2. После отправки сообщения чат-бот отправляет запрос в Directum RX на формирование задачи на исполнение заявки: сотрудникам, входящим в роль "Ответственные за заявки" отправляется простая задача от имени сотрудника, отправившего заявку через чат-бот. Вложение, прикрепленное к сообщению в чате, автоматически заносится в Directum RX с типом "Простой документ" и прикрепляется к задаче. В тексте задачи указывается текст, введенный пользователем в чат-боте.

## Настройка.
### Конфигурация чат-бота задается в файле BotWorkerService.dll.config:
1. **TelegramBotApiKey** - API ключ телеграм-бота. Создать нового бота или получить его ключ можно через телеграм-бота @BotFather.
2. **IntegrationServiceUrl** - адрес сервиса интеграции Directum RX.
3. **IntegrationUserLogin** - логин пользователя Directum RX, через которого будут отправляться запросы к сервису интеграции.
4. **IntegrationUserPassword** - пароль пользователя Directum RX
5. **MailAddress** - адрес ящика электронной почты для отправки кода подтверждения при регистрации пользователя.
6. **SmtpLogin** - логин ящика электронной почты.
7. **SmtpPassword** - пароль от ящика электронной почты.
8. **SmtpHost** - адрес сервера электронной почты.
9. **SmtpPort** - порт сервера электронной почты.
10. **SmtpSecure** - тип шифрования подключения к почтовому серверу. Возможные значения: Auto, None, SslOnConnect, StartTls, StartTlsWhenAvailable.

#### Пример настройки:
<pre>&lt;add key="TelegramBotApiKey" value="810946782:Pu3B3uaqqX18z5pXfMqS0sF8iEnMu1" /&gt;
&lt;add key="IntegrationServiceUrl" value="https://directumrx/Integration/odata" /&gt;
&lt;add key="IntegrationUserLogin" value="Service user" /&gt;
&lt;add key="IntegrationUserPassword" value="11111" /&gt;
&lt;add key="MailAddress" value="test@mail.ru" /&gt;
&lt;add key="SmtpLogin" value="test@mail.ru" /&gt;
&lt;add key="SmtpPassword" value="11111" /&gt;
&lt;add key="SmtpHost" value="smtp.mail.ru" /&gt;
&lt;add key="SmtpPort" value="25" /&gt;
&lt;add key="SmtpSecure" value="None" /&gt;</pre>

### Конфигурация логирования задается в файле nlog.config:
В атрибуте filename необходимо изменить папку, в которую будут записываться лог-файлы.

#### Пример настройки:
<pre>&lt;targets&gt;
  &lt;!-- Логирование в файл --&gt;  
  &lt;target xsi:type="File" name="fileTarget"  
      fileName="C:\TelegramBot\TelegramBot.${shortdate}.log"  
      archiveEvery="Day" archiveNumbering="Rolling"  
      layout="${longdate} [${level}] ${message} ${exception:format=ToString}" /&gt;  
&lt;/targets&gt;
</pre>
  
## Порядок установки службы
### Windows:
#### Выполнить в powershell скрипты:  
<pre>sc.exe create <Имя службы> binpath= <Путь к файлу .exe> start= auto  
sc.exe start <Имя службы></pre>

#### Пример:  
<pre>sc.exe create TelegramBotService binpath= "C:\bot\BotWorkerService.exe" start= auto  
sc.exe start TelegramBotService</pre>

### Linux:
1. Создать файл /etc/systemd/system/Telegram-bot.service
2. Вставить в созданный файл следующие строки (изменить путь к исполняемому файлу и к рабочей директории):
<pre>
[Unit]
Description=Telegram bot service
After=multi-user.target

[Service]
Type=simple
TimeoutSec=0
#команда для запуска вашего приложения такая же, как при обычном запуске в консоли
ExecStart=sudo -H -u user /home/user/TelegramBot/linux-x64/BotWorkerService
WorkingDirectory=/home/user/TelegramBot/linux-x64
Restart=always
User=user
# Restart service after 10 seconds if the dotnet service crashes:
RestartSec=10

[Install]
WantedBy=multi-user.target
</pre>

3. Перезапустить systemd:
<pre>sudo systemctl daemon-reload</pre>
4. Включить автозапуск сервиса при загрузке:
<pre>sudo systemctl enable Telegram-bot.service</pre>
5. Запустить сервис:
<pre>sudo systemctl start Telegram-bot.service</pre>

## Варианты использования на проекте:
### A. Использование готового функционала шаблона
1. Склонировать репозиторий в локальную папку, либо скачать zip-архив;
2. Собрать проект с помощью dotnet;
3. Настроить конфигурацию чат-бота и логирования;
4. Запустить сервис.

### B. Доработка функционала шаблона
#### Fork репозитория
1. Сделать fork репозитория TelegramBotIntegration для своей учетной записи;
2. Склонировать созданный в п. 1 репозиторий в папку;

#### Копирование репозитория в систему контроля версий
Рекомендуемый вариант для проектов внедрения.
1. В системе контроля версий с поддержкой git создать новый репозиторий;
2. Склонировать репозиторий TelegramBotIntegration в папку с ключом --mirror;
3. Перейти в папку из п. 2;
4. Импортировать клонированный репозиторий в систему контроля версий командой:
git push --mirror <Адрес репозитория из п. 1>

## Примеры расширения функциональности на проектах
1. Расширение списка сущностей для получения их справочной информации в чат-боте.
2. Структурирование и расширение сбора информации для отправки заявок.
3. Вывод свойств документа при отправке в чат.
